<!--
 * @Author: tangdaoyong
 * @Date: 2021-02-09 14:06:41
 * @LastEditors: tangdaoyong
 * @LastEditTime: 2021-02-09 15:18:50
 * @Description: ICMP
-->
# ICMP协议

`IP协议`并不是一个可靠的协议，它不保证数据被送达，那么，自然的，保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是`ICMP(网络控制报文)`协议。`ICMP`不是高层协议，而是`IP`层的协议。

当传送`IP`数据包发生错误。比如主机不可达，路由不可达等等，`ICMP`协议将会把错误信息封包，然后传送回给主机。给主机一个处理错误的机会，这也就是为什么说建立在`IP`层以上的协议是可能做到安全的原因。

## ping
ping可以说是ICMP的最著名的应用，是TCP/IP协议的一部分。利用“ping”命令可以检查网络是否连通，可以很好地帮助我们分析和判定网络故障。

例如：当我们某一个网站上不去的时候。通常会ping一下这个网站。ping会回显出一些有用的信息。

ping这个单词源自声纳定位，而这个程序的作用也确实如此，它利用ICMP协议包来侦测另一个主机是否可达。原理是用类型码为0的ICMP发请求，受到请求的主机则用类型码为8的ICMP回应。

## Traceroute

Traceroute是用来侦测主机到目的主机之间所经路由情况的重要工具，也是最便利的工具。

Traceroute的原理是非常非常的有意思，它收到到目的主机的IP后，首先给目的主机发送一个TTL=1的UDP数据包，而经过的第一个路由器收到这个数据包以后，就自动把TTL减1，而TTL变为0以后，路由器就把这个包给抛弃了，并同时产生 一个主机不可达的ICMP数据报给主机。主机收到这个数据报以后再发一个TTL=2的UDP数据报给目的主机，然后刺激第二个路由器给主机发ICMP数据 报。如此往复直到到达目的主机。这样，traceroute就拿到了所有的路由器IP。
```
ping_t www.red-alert.testing.bbdops.com
traceroute to www.red-alert.testing.bbdops.com (10.28.111.9), 64 hops max, 52 byte packets
 1  192.168.104.1 (192.168.104.1)  7.277 ms  1.830 ms  1.412 ms
 2  172.17.2.1 (172.17.2.1)  1.233 ms  1.735 ms  1.496 ms
 3  138.94.1.138 (138.94.1.138)  38.039 ms  38.574 ms  38.778 ms
 4  172.30.5.2 (172.30.5.2)  40.413 ms  41.192 ms  40.617 ms
 5  10.28.111.9 (10.28.111.9)  39.181 ms  44.893 ms  41.987 ms
 6  10.28.111.9 (10.28.111.9)  39.290 ms  39.888 ms  40.127 ms
```
```
$ traceroute www.baidu.com
traceroute: Warning: www.baidu.com has multiple addresses; using 182.61.200.7
traceroute to www.a.shifen.com (182.61.200.7), 64 hops max, 52 byte packets
 1  192.168.104.1 (192.168.104.1)  6.676 ms  2.499 ms  13.355 ms
 2  adsl-172-10-1-1.dsl.sndg02.sbcglobal.net (172.10.1.1)  1.827 ms  3.642 ms  1.254 ms
 3  182.150.28.1 (182.150.28.1)  4.097 ms  6.688 ms  3.996 ms
 4  202.98.114.89 (202.98.114.89)  12.758 ms  43.606 ms  11.459 ms
 5  171.208.196.9 (171.208.196.9)  4.701 ms
    171.208.199.245 (171.208.199.245)  4.495 ms
    110.188.6.73 (110.188.6.73)  5.288 ms
 6  202.97.98.97 (202.97.98.97)  36.087 ms
    202.97.72.137 (202.97.72.137)  36.761 ms
    202.97.98.101 (202.97.98.101)  40.169 ms
 7  36.110.248.86 (36.110.248.86)  39.773 ms
    36.110.245.94 (36.110.245.94)  36.274 ms  35.377 ms
 8  36.110.246.69 (36.110.246.69)  47.010 ms
    36.110.249.70 (36.110.249.70)  37.725 ms
    36.110.246.205 (36.110.246.205)  42.204 ms
 9  182.61.255.60 (182.61.255.60)  40.043 ms
    182.61.255.64 (182.61.255.64)  36.022 ms
    220.181.17.114 (220.181.17.114)  45.401 ms
10  182.61.255.68 (182.61.255.68)  38.336 ms
    182.61.255.53 (182.61.255.53)  52.480 ms
    182.61.255.68 (182.61.255.68)  38.047 ms
11  * 182.61.255.59 (182.61.255.59)  40.321 ms *
```